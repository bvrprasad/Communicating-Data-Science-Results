---
title: 'Crime Analysis: San Francisco, Summer 2014 '
author: "Prasad Bandaru"
date: "24 January 2016"
output: html_document
---

The criminal incident data from San Francisco for the summer of 2014 has been made public. I would like to make an visual analysis on these incidents and try to answer the following questions.  

* How do incidents vary by time of day?
* How do incidents vary by district?
* How do incidents vary month to month?
* Which incident types tend to correlate with each other on a day-by-day basis?

# Initial setup

Load the required libraries.

```{r message=FALSE}
library("dplyr")
library("lubridate")
library("ggplot2")
library("caret")
```

# Dataset overview
Read the san francisco crime incidents data. Initial look at the data reveals that it contains 13 fields. Of these category, date, time and area details are important for my current analysis. There are 34 categories of crime as listed below.

```{r}
san <- read.csv("sanfrancisco_incidents_summer_2014.csv")
str(san)
levels(san$Category)
```

## Enriching data
I enriched the data by converting the Date field to proper date format. Additionally I deduct Hour and Month and store them in separate fields. I also re-arranged the DayOfWeek from Monday to Sunday. In this way it is easier to use the data in the analysis. I add an additional count field to make it easier for aggregation.

```{r}
san$Date <- as.POSIXct(strptime(san$Date, format = "%m/%d/%Y"))
san$Hour <- as.factor(hour(as.POSIXlt(strptime(san$Time, format = "%H:%M"))))
san$Month <- as.factor(month(san$Date, label = TRUE))
san$DayOfWeek <- factor(san$DayOfWeek, 
                   levels = c("Monday", "Tuesday",  "Wednesday", "Thursday", 
                              "Friday", "Saturday", "Sunday"))
san$Count <- c(1)
```

# How incidents vary by time of day
I consider only the Hour part of the time and plot the incidents count for the top 5 category. The plot reveals that theft has a higher variation over the day. The number of thefts increases slowly over the day and peaks at 6pm. Then it gradually comes down and is at minimum between 4 am and 5 am. Also, there are more vehicle thefts in the evening.

```{r}
counts <- aggregate(Count ~ Category + Hour, data = san, sum)
topCrimes <- aggregate(Count ~ Category, data = san, sum)
topX <- topCrimes$Category [order (topCrimes$Count, decreasing = TRUE)]
#counts$Category <- substr(counts$Category, 1, 11)
ggplot(data = subset(counts, Category %in% topX [1 : 5]), aes(Hour, Count)) +
  labs(title = "Top 5 Incidents variation by time of day", x = "Hour of the day", y = "Incidents count") +
  theme(axis.text.y = element_text(size = 6, color = "blue")) +
  theme(strip.text = element_text(size = 10)) +
  theme(axis.text.x = element_text(size = 4, angle = 90, hjust = 1, color = "blue")) + 
  geom_line(aes(colour=Category, group=Category)) + 
  geom_point(aes(colour=Category), size=3)    
```

# How incidents vary by district
Further I split the top 5 incidents by district. It reveals that the number of thefts are more in central, northern and southern districts compared to other districts.

```{r}
areawise <- aggregate(Count ~ Category + PdDistrict, data = san, sum)
ggplot(data = subset(areawise, Category %in% topX [1 : 5]), aes(PdDistrict, Count)) +
  facet_grid(~ Category) +
  labs(title = "Incidents by district", x = "Hour of the day", y = "Incidents count") +
  theme(axis.text = element_text(size = 6, color = "blue")) +
  theme(strip.text = element_text(size = 10)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  geom_point(color = c("red"))
```

# How thefts vary in the southern district
Further analysing the thefts in the southern district. 

## How thefts vary in the southern district by day-of-week
Plotting the thefts count by day-of-week reveals that there are only few variations over the week. And little higher value during the weekend.

```{r}
southern <- san[san$PdDistrict == "SOUTHERN" & san$Category == "LARCENY/THEFT", ]
counts <- aggregate(Count ~ DayOfWeek, data = southern, sum)
ggplot(counts, aes(DayOfWeek, Count)) + 
  labs(title = "Thefts in southern district by day-of-week", x = "DayOfWeek", y = "Thefts count") +
  theme(axis.text.y = element_text(size = 6, color = "blue")) + ylim(0,500) +
  theme(axis.text.x = element_text(size = 10, color = "blue", angle = 90, hjust = 1)) + 
  geom_point(color = c("red")) +
  geom_smooth(method = "lm", se = FALSE)
```

## How thefts vary in the southern district by date
Plotting the thefts count by date reveals that the thefts tend to increase over the summer months.

```{r}
counts <- aggregate(Count ~ Date, data = southern, sum)
ggplot(counts, aes(Date, Count)) + 
  labs(title = "Thefts in southern district by date", x = "Date", y = "Thefts count") +
  theme(axis.text.y = element_text(size = 6, color = "blue")) + ylim(0,60) +
  theme(axis.text.x = element_text(size = 10, color = "blue", angle = 90, hjust = 1)) + 
  geom_point(color = c("red")) +
  geom_smooth(method = "lm", se = TRUE)
```

## Areas with most common robberies or thefts
I filtered the categories: ROBBERY, VEHICLE THEFT, LARCENCY/THEFT and BURGLARY, to find the areas where these incidents are common. Robbery is common in all districts, while Burglary happened only in the districts: MISSION, NORTHERN, TARAVAL and TENDERLOIN. LARCENCY/THEFT is higher among these categories and is particular higher in districts: CENTRAL, NORTHERN and SOUTHERN.

```{r}
thefts <- san[san$Category == "ROBBERY" | san$Category == "VEHICLE THEFT" |
                san$Category == "LARCENY/THEFT" | san$Category == "BURGLARY", ]
common <- aggregate(Count ~ Category + PdDistrict, data = thefts, sum)
ggplot(common, aes(PdDistrict, Count)) +
  labs(title = "Robberies/Thefts by Area", x = "Area", y = "Incidents count") +
  facet_wrap(~ Category) +   
  theme(axis.text = element_text(size = 6, color = "blue")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  geom_point(color = c("red"))
```

# Incidents variation for the given Summer months
The dataset consists only of the summer months: June, July and August. Plotting the total incidents per month reveals that the crimes are linearly increasing. This means that there is a need for increased police officials in July compared to June and some more increase for police officials in August compared to July.

```{r}
levels(san$Month)
months <- aggregate(Count ~ Month, data = san, sum)
ggplot(months, aes(Month, Count)) +
  labs(title = "Incidents variantion by month", x = "Month", y = "Incidents count") +
  theme(axis.text = element_text(size = 10, color = "blue")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  geom_point(color = c("red")) 
```

# Incident types correlation on day-of-week basis
Plotting the various incidents on day-of-week basis show that there are more incidents during the weekend with Friday being the highest.

```{r}
daily <- aggregate(Count ~ DayOfWeek, data = san, sum)
ggplot(daily, aes(DayOfWeek, Count)) + 
  labs(title = "Day-by-day incidents variantions", x = "DayOfWeek", y = "Incidents count") +
  theme(axis.text.y = element_text(size = 6, color = "blue")) +
  theme(axis.text.x = element_text(size = 10, color = "blue", angle = 90, hjust = 1)) + 
  geom_point(color = c("red"))
```

